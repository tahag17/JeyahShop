<!-- Header -->
<header
  class="w-full bg-surfaceLight dark:bg-surfaceDark shadow-md px-2 sm:px-6 py-3 flex items-center justify-between sticky top-0 z-50"
>
  <!-- Logo -->
  <div class="flex items-center gap-2 hidden md:flex">
    <h1
      class="text-xl sm:text-2xl font-bold font-heading text-primaryTail dark:text-primaryDarkTail"
    >
      Jeyah
    </h1>
  </div>

  <!-- Search bar -->
  <div class="flex-1 flex justify-center mx-1 sm:mx-4 relative">
    <div
      class="flex w-full max-w-[480px] xs:max-w-[260px] sm:max-w-[340px] md:max-w-[420px] lg:max-w-[520px] border border-gray-300 dark:border-gray-600 rounded overflow-hidden transition-all duration-200 focus-within:ring-2 focus-within:ring-accentTail dark:focus-within:ring-accentDarkTail"
    >
      <input
        type="text"
        placeholder="Rechercher des produits..."
        [(ngModel)]="searchInput"
        (input)="onSearch()"
        (focus)="showSearchSuggestions = true"
        (blur)="hideSuggestions()"
        class="flex-1 px-2 sm:px-3 py-1 text-textLight dark:text-textDark focus:outline-none bg-transparent"
      />
      <button
        class="bg-accentTail dark:bg-accentDarkTail text-white px-2 sm:px-3 py-1 hover:bg-accentTail/80 dark:hover:bg-accentDarkTail/80 transition"
        (click)="onSearch()"
      >
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </div>

    <!-- Search suggestions dropdown -->
    <ul
      *ngIf="showSearchSuggestions && filteredSuggestions.length"
      class="absolute top-full mt-1 w-full bg-surfaceLight dark:bg-surfaceDark border border-gray-300 dark:border-gray-600 rounded shadow-lg z-50 max-h-60 overflow-y-auto"
    >
      <li
        *ngFor="let suggestion of filteredSuggestions"
        (mousedown)="selectSuggestion(suggestion)"
        class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-textLight dark:text-textDark"
      >
        {{ suggestion }}
      </li>
    </ul>
  </div>

  <!-- Right side -->
  <div class="flex items-center gap-x-1 sm:gap-x-4 relative">
    <!-- Dashboard button (desktop only) -->
    <button
      *ngIf="isManagerOrAdmin"
      class="hidden md:flex items-center gap-1 sm:gap-2 transition px-3 py-1 rounded-md bg-accentTail dark:bg-accentDarkTail text-white hover:bg-accentTail/90 dark:hover:bg-accentDarkTail/90 shadow-sm hover:shadow-md"
      (click)="router.navigate(['/dashboard'])"
    >
      <i class="fa-solid fa-chart-line"></i>
      <span class="hidden sm:inline font-medium">Dashboard</span>
    </button>

    <!-- Profile (desktop only) -->
    <div class="relative hidden md:flex">
      <button
        class="flex items-center gap-1 sm:gap-2 transition px-2 py-1 rounded-md text-blue-600 border border-blue-500 ring-2 ring-blue-400 dark:ring-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20"
        (click)="handleProfileClick()"
      >
        <i
          class="fa-solid fa-user transition-all duration-200 rounded-full p-1 ring-2 ring-blue-500 hover:scale-110"
        ></i>
        <span class="hidden sm:inline font-medium">Votre profil</span>
      </button>

      <!-- Profile dropdown (desktop) -->
      <div
        *ngIf="profileDropdownOpen"
        class="absolute right-0 top-full mt-2 w-48 bg-surfaceLight dark:bg-surfaceDark border border-gray-300 dark:border-gray-600 rounded shadow-lg z-50 flex flex-col divide-y divide-gray-200 dark:divide-gray-700"
      >
        <button
          class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-textLight dark:text-textDark"
          (click)="router.navigate(['/profile']); profileDropdownOpen = false"
        >
          Profil
        </button>
        <button
          class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-textLight dark:text-textDark"
          (click)="router.navigate(['/orders']); profileDropdownOpen = false"
        >
          Mes commandes
        </button>
        <button
          class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-textLight dark:text-textDark"
          (click)="router.navigate(['/settings']); profileDropdownOpen = false"
        >
          Paramètres
        </button>
        <button
          class="px-4 py-2 hover:bg-red-100 dark:hover:bg-red-700/20 transition text-red-600 dark:text-red-400"
          (click)="logout(); profileDropdownOpen = false"
        >
          Se déconnecter
        </button>
      </div>
    </div>

    <!-- Cart (desktop only) -->
    <div class="relative hidden md:block">
      <button
        class="relative p-1 sm:p-2 rounded transition text-blue-600 hover:bg-gray-200 dark:hover:bg-gray-700"
        (click)="handleCartClick()"
      >
        <i class="fa-solid fa-cart-shopping text-lg sm:text-xl"></i>
        <span
          *ngIf="isLoggedIn"
          class="absolute -top-1 -right-1 bg-dangerTail text-white text-[10px] sm:text-xs rounded-full px-[3px]"
        >
          {{ cartCount }}
        </span>
      </button>

      <!-- Cart dropdown (desktop) -->
      <div
        *ngIf="cartDropdownOpen"
        class="absolute right-0 top-full mt-2 w-72 bg-surfaceLight dark:bg-surfaceDark border border-gray-300 dark:border-gray-600 rounded-2xl shadow-lg z-50 flex flex-col divide-y divide-gray-200 dark:divide-gray-700 max-h-80 overflow-y-auto"
      >
        <div
          *ngIf="cart?.items?.length; else emptyCart"
          class="p-4 flex flex-col gap-3"
        >
          <div
            *ngFor="let item of cart?.items"
            class="flex justify-between items-center"
          >
            <div class="flex items-center gap-3">
              <img
                *ngIf="item.imageUrl"
                [src]="item.imageUrl"
                alt="{{ item.productName }}"
                class="w-12 h-12 object-cover rounded-md"
              />
              <span class="text-textLight dark:text-textDark font-medium">{{
                item.productName
              }}</span>
            </div>
            <span class="text-textLight/70 dark:text-textDark/70 font-medium"
              >{{ item.quantity }} x {{ item.price | currency : "EUR" }}</span
            >
          </div>
          <div
            class="flex justify-between mt-3 pt-3 border-t border-gray-300 dark:border-gray-600 font-semibold text-textLight dark:text-textDark"
          >
            <span>Total:</span>
            <span>{{ cart?.totalPrice | currency : "EUR" }}</span>
          </div>
          <button
            class="mt-3 w-full py-2 px-3 bg-accentTail dark:bg-accentDarkTail text-white rounded-lg hover:bg-accentTail/90 dark:hover:bg-accentDarkTail/90 transition-all shadow-sm hover:shadow-md"
            (click)="router.navigate(['/cart']); cartDropdownOpen = false"
          >
            Voir mon panier
          </button>
        </div>
        <ng-template #emptyCart>
          <div class="p-6 text-center text-textLight dark:text-textDark/80">
            Votre panier est vide
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Dark mode toggle -->
    <app-dark-mode-toggle
      class="ml-1 sm:ml-2 md:ml-4 lg:ml-6 xl:ml-8"
    ></app-dark-mode-toggle>

    <!-- Hamburger (mobile only) -->
    <button
      class="md:hidden p-1 sm:p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition"
      (click)="toggleMenu()"
    >
      <i class="fa-solid fa-bars text-textLight dark:text-textDark"></i>
    </button>

    <!-- Mobile menu dropdown -->
    <div
      *ngIf="menuOpen"
      class="absolute top-full right-0 mt-2 w-56 bg-surfaceLight dark:bg-surfaceDark border border-gray-300 dark:border-gray-600 rounded shadow-lg z-50 flex flex-col divide-y divide-gray-200 dark:divide-gray-700 md:hidden"
    >
      <button
        class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-textLight dark:text-textDark text-left w-full"
        (click)="
          isLoggedIn
            ? router.navigate(['/profile'])
            : (notConnectedModalOpen = true);
          menuOpen = false
        "
      >
        Profil
      </button>
      <button
        class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-textLight dark:text-textDark text-left w-full"
        (click)="
          isLoggedIn
            ? router.navigate(['/orders'])
            : (notConnectedModalOpen = true);
          menuOpen = false
        "
      >
        Mes commandes
      </button>
      <button
        class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-textLight dark:text-textDark text-left w-full"
        (click)="
          isLoggedIn
            ? router.navigate(['/settings'])
            : (notConnectedModalOpen = true);
          menuOpen = false
        "
      >
        Paramètres
      </button>
      <button
        *ngIf="isLoggedIn"
        class="px-4 py-2 hover:bg-red-100 dark:hover:bg-red-700/20 text-red-600 dark:text-red-400 text-left w-full"
        (click)="logout(); menuOpen = false"
      >
        Se déconnecter
      </button>
      <button
        class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-textLight dark:text-textDark text-left w-full flex justify-between items-center"
        (click)="handleCartClick(); menuOpen = false"
      >
        Panier
        <span
          *ngIf="cartCount > 0"
          class="bg-dangerTail text-white text-xs px-2 rounded-full"
          >{{ cartCount }}</span
        >
      </button>
    </div>
  </div>
</header>

<!-- Not Connected Modal -->
<div
  *ngIf="notConnectedModalOpen"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 backdrop-blur-sm"
>
  <div
    class="bg-surfaceLight dark:bg-surfaceDark rounded-lg p-6 w-96 shadow-lg flex flex-col gap-4"
  >
    <h3 class="text-xl font-bold text-textLight dark:text-textDark">
      Vous n'êtes pas connecté
    </h3>
    <p class="text-textLight/80 dark:text-textDark/80">
      Pour accéder à cette fonctionnalité, vous devez vous connecter.
      Voulez-vous vous connecter maintenant ?
    </p>

    <div class="flex justify-end gap-2">
      <button
        class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-700 text-textLight dark:text-textDark hover:bg-gray-300 dark:hover:bg-gray-600 transition"
        (click)="notConnectedModalOpen = false"
      >
        Annuler
      </button>
      <button
        class="px-4 py-2 rounded-md bg-accentTail dark:bg-accentDarkTail text-white hover:bg-accentTail/90 dark:hover:bg-accentDarkTail/90 transition"
        (click)="router.navigate(['/login']); notConnectedModalOpen = false"
      >
        Se Connecter
      </button>
    </div>
  </div>
</div>

<!-- Custom style for screens < 320px -->
<style>
  @media (max-width: 320px) {
    header input {
      max-width: 150px !important;
      font-size: 0.75rem !important;
    }
  }
</style>
