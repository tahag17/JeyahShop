<div
  *ngIf="user$ | async as user"
  class="max-w-6xl mx-auto p-6 bg-surfaceLight dark:bg-surfaceDark rounded-xl shadow-md space-y-2"
>
  <!-- Header -->
  <div
    class="flex gap-4 items-center md:justify-start justify-between text-primaryTail dark:text-primaryDarkTail"
  >
    <h2 class="text-xl xl:text-4xl font-heading font-bold">
      {{
        user.fullName ||
          (user.firstName || user.lastName
            ? (user.firstName || "") + " " + (user.lastName || "")
            : "Non fourni")
      }}
    </h2>
    <div
      class="hidden md:flex text-2xl font-heading hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded-md p-1"
      (click)="openEditUserModal(user)"
    >
      <i class="fa-solid fa-user-pen"></i>
      modifier
    </div>

    <!-- Small screen: show only icon -->
    <div
      class="flex md:hidden sm:text-lg text-xl font-heading hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded-md p-1 cursor-pointer"
      (click)="openEditUserModal(user)"
    >
      <i class="fa-solid fa-user-pen"></i>
    </div>
  </div>

  <!-- Infos principales (email + compte activé) -->
  <div class="space-y-2">
    <p
      class="text-base text-textLight dark:text-textDark hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1"
    >
      <span class="font-semibold">Email :</span>
      {{ user.email || "Non fourni" }}
    </p>

    <p
      class="text-base text-textLight dark:text-textDark hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1"
    >
      <span class="font-semibold">Compte activé :</span>
      <span
        [ngClass]="{
          'text-successTail': user.enabled,
          'text-dangerTail': !user.enabled
        }"
      >
        {{ user.enabled ? "Oui" : "Non" }}
      </span>
    </p>
  </div>

  <!-- Infos modifiables -->
  <div class="space-y-2">
    <!-- Téléphone (inline editing) -->

    <!-- Phone -->
    <div
      class="flex flex-col md:flex-row justify-between md:items-center hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1 gap-2"
    >
      <!-- Label + input/text -->
      <div
        class="flex-1 flex flex-col md:flex-row md:items-center gap-2 w-full"
      >
        <span
          class="font-semibold text-base text-textLight dark:text-textDark flex-shrink-0"
          >Téléphone :</span
        >

        <ng-container *ngIf="editingPhone; else phoneText">
          <input
            type="text"
            [(ngModel)]="phoneValue"
            (keydown.enter)="savePhone()"
            (keydown.escape)="cancelPhoneEdit()"
            class="border rounded px-2 py-1 text-sm text-textLight dark:text-textDark focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none w-full md:w-auto"
          />
        </ng-container>

        <ng-template #phoneText>
          <span class="text-textLight dark:text-textDark">{{
            user.phone || "Non fourni"
          }}</span>
        </ng-template>
      </div>

      <!-- Buttons -->
      <div
        class="flex flex-col md:flex-row md:items-center gap-2 md:mt-0 w-full md:w-auto"
      >
        <button
          *ngIf="editingPhone"
          class="px-2 py-1 bg-successTail text-white rounded hover:bg-successTail/80 text-sm transition w-full md:w-auto"
          (click)="savePhone()"
        >
          Sauvegarder
        </button>
        <button
          *ngIf="editingPhone"
          class="px-2 py-1 bg-dangerTail text-white rounded hover:bg-dangerTail/80 text-sm transition w-full md:w-auto"
          (click)="cancelPhoneEdit()"
        >
          Annuler
        </button>
        <button
          *ngIf="!editingPhone"
          class="px-2 py-1 bg-accentTail dark:bg-accentDarkTail text-white rounded hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-sm transition w-full md:w-auto"
          (click)="startEditPhone()"
        >
          Modifier
        </button>
      </div>
    </div>

    <!-- First Name (inline editing) -->
    <div
      class="flex flex-col md:flex-row justify-between items-center md:items-center p-1 hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded"
    >
      <span
        class="text-base text-textLight dark:text-textDark w-full md:w-auto flex items-center"
      >
        <span class="font-semibold mr-2">Prénom :</span>

        <ng-container *ngIf="editingFirstName; else firstNameText">
          <input
            type="text"
            [(ngModel)]="firstNameValue"
            (keydown.enter)="saveFirstName()"
            (keydown.escape)="cancelFirstNameEdit()"
            class="border rounded px-2 py-1 text-sm focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none text-textLight w-full md:w-auto"
          />
        </ng-container>

        <ng-template #firstNameText>
          {{ user.firstName || "Non fourni" }}
        </ng-template>
      </span>

      <!-- Buttons -->
      <div class="flex flex-col md:flex-row gap-2 md:mt-0 w-full md:w-auto">
        <button
          *ngIf="!editingFirstName"
          class="w-full md:w-auto px-2 py-1 bg-accentTail dark:bg-accentDarkTail text-white rounded hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-sm transition"
          (click)="startEditFirstName()"
        >
          Modifier
        </button>

        <ng-container *ngIf="editingFirstName">
          <button
            class="w-full md:w-auto px-2 py-1 bg-successTail text-white rounded hover:bg-successTail/80 text-sm transition"
            (click)="saveFirstName()"
          >
            Sauvegarder
          </button>
          <button
            class="w-full md:w-auto px-2 py-1 bg-dangerTail text-white rounded hover:bg-dangerTail/80 text-sm transition"
            (click)="cancelFirstNameEdit()"
          >
            Annuler
          </button>
        </ng-container>
      </div>
    </div>

    <!-- Last Name -->

    <div
      class="flex flex-col md:flex-row justify-between hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1"
    >
      <!-- Left: label + input/text -->
      <div class="flex-1 flex items-center gap-2">
        <span class="font-semibold text-base text-textLight dark:text-textDark"
          >Nom :</span
        >

        <ng-container *ngIf="editingLastName; else lastNameText">
          <input
            type="text"
            [(ngModel)]="lastNameValue"
            (keydown.enter)="saveLastName()"
            (keydown.escape)="cancelLastNameEdit()"
            class="border rounded px-2 py-1 text-sm focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none text-textLight w-full md:w-auto"
          />
        </ng-container>

        <ng-template #lastNameText>
          <span class="text-textLight dark:text-textDark w-full md:w-auto">
            {{ user.lastName || "Non fourni" }}
          </span>
        </ng-template>
      </div>

      <!-- Buttons -->
      <div
        class="flex flex-col md:flex-row gap-2 md:mt-0 md:items-center w-full md:w-auto"
      >
        <button
          *ngIf="editingLastName"
          class="px-2 py-1 bg-successTail text-white rounded hover:bg-successTail/80 text-sm transition w-full md:w-auto"
          (click)="saveLastName()"
        >
          Sauvegarder
        </button>
        <button
          *ngIf="editingLastName"
          class="px-2 py-1 bg-dangerTail text-white rounded hover:bg-dangerTail/80 text-sm transition w-full md:w-auto"
          (click)="cancelLastNameEdit()"
        >
          Annuler
        </button>
        <button
          *ngIf="!editingLastName"
          class="px-2 py-1 bg-accentTail dark:bg-accentDarkTail text-white rounded hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-sm transition w-full md:w-auto"
          (click)="startEditLastName()"
        >
          Modifier
        </button>
      </div>
    </div>

    <!-- adressw -->
    <div
      class="flex flex-col md:flex-row justify-between md:items-center hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1 gap-2"
    >
      <!-- Label -->
      <p
        class="font-semibold text-base text-textLight dark:text-textDark flex-shrink-0"
      >
        Adresse :
      </p>

      <!-- Fields -->
      <div class="flex flex-col md:flex-row md:items-center md:gap-4 w-full">
        <!-- Rue -->
        <div class="flex flex-col md:flex-row md:items-center gap-1">
          <span class="font-semibold text-sm text-textLight dark:text-textDark"
            >Rue :</span
          >
          <ng-container *ngIf="editingAddress; else streetText">
            <input
              type="text"
              [(ngModel)]="streetValue"
              (keydown.enter)="saveAddress()"
              (keydown.escape)="cancelEditAddress()"
              class="border rounded px-2 py-1 text-sm focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none text-textLight"
            />
          </ng-container>
          <ng-template #streetText>
            <span class="text-base text-textLight dark:text-textDark">{{
              user.address?.street || "Non fourni"
            }}</span>
          </ng-template>
        </div>

        <!-- Code postal -->
        <div class="flex flex-col md:flex-row md:items-center gap-1">
          <span class="font-semibold text-sm text-textLight dark:text-textDark"
            >Code postal :</span
          >
          <ng-container *ngIf="editingAddress; else postalCodeText">
            <input
              type="text"
              [(ngModel)]="postalCodeValue"
              (keydown.enter)="saveAddress()"
              (keydown.escape)="cancelEditAddress()"
              class="border rounded px-2 py-1 text-sm focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none text-textLight"
            />
          </ng-container>
          <ng-template #postalCodeText>
            <span class="text-base text-textLight dark:text-textDark">{{
              user.address?.postalCode || "Non fourni"
            }}</span>
          </ng-template>
          <div *ngIf="postalCodeError" class="text-dangerTail text-xs mt-1">
            {{ postalCodeError }}
          </div>
        </div>

        <!-- Ville -->
        <div class="flex flex-col md:flex-row md:items-center gap-1">
          <span class="font-semibold text-sm text-textLight dark:text-textDark"
            >Ville :</span
          >
          <ng-container *ngIf="editingAddress; else cityText">
            <input
              type="text"
              [(ngModel)]="cityValue"
              (keydown.enter)="saveAddress()"
              (keydown.escape)="cancelEditAddress()"
              class="border rounded px-2 py-1 text-sm focus:border-accentTail dark:focus:border-accentDarkTail focus:ring-2 focus:ring-accentTail dark:focus:ring-accentDarkTail outline-none text-textLight"
            />
          </ng-container>
          <ng-template #cityText>
            <span class="text-base text-textLight dark:text-textDark">{{
              user.address?.city || "Non fourni"
            }}</span>
          </ng-template>
        </div>
      </div>

      <!-- Buttons -->
      <div
        class="flex flex-col md:flex-row md:items-center gap-2 md:mt-0 w-full md:w-auto"
      >
        <button
          *ngIf="editingAddress"
          class="px-2 py-1 bg-successTail text-white rounded hover:bg-successTail/80 text-sm transition w-full md:w-auto"
          (click)="saveAddress()"
        >
          Sauvegarder
        </button>
        <button
          *ngIf="editingAddress"
          class="px-2 py-1 bg-dangerTail text-white rounded hover:bg-dangerTail/80 text-sm transition w-full md:w-auto"
          (click)="cancelEditAddress()"
        >
          Annuler
        </button>
        <button
          *ngIf="!editingAddress"
          class="px-2 py-1 bg-accentTail dark:bg-accentDarkTail text-white rounded hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-sm transition w-full md:w-auto"
          (click)="startEditAddress()"
        >
          Modifier
        </button>
      </div>
    </div>

    <!-- Password -->
    <div
      class="flex flex-col md:flex-row justify-between hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1"
    >
      <div class="flex-1 flex items-center gap-2">
        <span class="font-semibold text-base text-textLight dark:text-textDark"
          >Mot de passe :</span
        >
        <ng-container *ngIf="user.hasPassword; else noPassword"
          >********</ng-container
        >
        <ng-template #noPassword>
          <span class="italic text-gray-400">Non défini</span>
        </ng-template>
      </div>

      <div
        class="flex flex-col md:flex-row gap-2 md:mt-0 md:items-center w-full md:w-auto"
      >
        <button
          class="px-2 py-1 bg-accentTail dark:bg-accentDarkTail text-white rounded hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-sm transition w-full md:w-auto"
          (click)="openPasswordModal(user)"
        >
          {{ user.hasPassword ? "Modifier" : "Définir" }}
        </button>
      </div>
    </div>

    <!-- Rôles (seulement pour manager ou admin) -->
    <div
      *ngIf="
        user &&
        (user.roles.includes('ROLE_ADMIN') ||
          user.roles.includes('ROLE_MANAGER'))
      "
      class="flex justify-between items-center hover:bg-accentTail/20 dark:hover:bg-accentDarkTail/20 rounded p-1"
    >
      <span class="text-base text-textLight dark:text-textDark">
        <span class="font-semibold mr-2">Rôles :</span>
        {{ user.roles.join(", ") }}
      </span>
    </div>
  </div>

  <!-- Dates -->
  <div class="pt-4 space-y-2 border-t border-gray-300 dark:border-gray-600">
    <p class="text-sm text-gray-500 dark:text-gray-400">
      <span class="font-semibold">Créé le :</span>
      {{ user.creationDate | date : "medium" }}
    </p>

    <p class="text-sm text-gray-500 dark:text-gray-400">
      <span class="font-semibold">Dernière modification :</span>
      {{
        user.lastModifiedDate
          ? (user.lastModifiedDate | date : "medium")
          : "Jamais"
      }}
    </p>
  </div>
</div>

<!-- Password Modal -->
<div
  *ngIf="isPasswordModalOpen"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div
    class="bg-surfaceLight dark:bg-surfaceDark rounded-lg p-6 w-96 shadow-lg"
  >
    <h3 class="text-xl font-bold mb-4 text-textLight dark:text-textDark">
      {{
        isSettingPassword
          ? "Définir un mot de passe"
          : "Modifier le mot de passe"
      }}
    </h3>

    <form
      (ngSubmit)="savePassword()"
      class="space-y-3 text-textLight dark:text-textDark"
    >
      <!-- Old password (only if modifying) -->
      <div *ngIf="!isSettingPassword">
        <label class="block text-sm font-medium mb-1"
          >Ancien mot de passe</label
        >
        <input
          type="password"
          [(ngModel)]="oldPassword"
          name="oldPassword"
          required
          class="w-full border rounded px-2 py-1"
        />
      </div>

      <!-- New password -->
      <div>
        <label class="block text-sm font-medium mb-1"
          >Nouveau mot de passe</label
        >
        <input
          type="password"
          [(ngModel)]="newPassword"
          name="newPassword"
          required
          class="w-full border rounded px-2 py-1"
        />
      </div>

      <!-- Confirm password -->
      <div>
        <label class="block text-sm font-medium mb-1"
          >Confirmer le mot de passe</label
        >
        <input
          type="password"
          [(ngModel)]="confirmPassword"
          name="confirmPassword"
          required
          class="w-full border rounded px-2 py-1"
        />
      </div>

      <div *ngIf="passwordError" class="text-red-500 text-sm mb-2">
        {{ passwordError }}
      </div>

      <!-- Actions -->
      <div class="flex justify-end gap-2 mt-4">
        <button
          type="button"
          class="px-3 py-1 bg-dangerTail hover:bg-dangerTail/80 text-white rounded"
          (click)="closePasswordModal()"
        >
          Annuler
        </button>
        <button
          type="submit"
          class="px-3 py-1 bg-accentTail dark:bg-accentDarkTail hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-white rounded disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-accentTail disabled:dark:hover:bg-accentDarkTail"
          [disabled]="
            !newPassword || !confirmPassword || newPassword !== confirmPassword
          "
        >
          Sauvegarder
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit User Modal -->
<div
  *ngIf="isEditUserModalOpen"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div
    class="bg-surfaceLight dark:bg-surfaceDark rounded-lg p-6 w-96 shadow-lg"
  >
    <h3 class="text-xl font-bold mb-4 text-textLight dark:text-textDark">
      Modifier l'utilisateur
    </h3>

    <form
      (ngSubmit)="saveUserEdits()"
      class="space-y-3 text-textLight dark:text-textDark"
    >
      <!-- First Name -->
      <div>
        <label class="block text-sm font-medium mb-1">Prénom</label>
        <input
          type="text"
          [(ngModel)]="editFirstName"
          name="editFirstName"
          required
          class="w-full border rounded px-2 py-1 text-textLight"
        />
      </div>

      <!-- Last Name -->
      <div>
        <label class="block text-sm font-medium mb-1">Nom</label>
        <input
          type="text"
          [(ngModel)]="editLastName"
          name="editLastName"
          required
          class="w-full border rounded px-2 py-1 text-textLight"
        />
      </div>

      <!-- Phone -->
      <div>
        <label class="block text-sm font-medium mb-1">Téléphone</label>
        <input
          type="text"
          [(ngModel)]="editPhone"
          name="editPhone"
          class="w-full border rounded px-2 py-1 text-textLight"
        />
      </div>

      <!-- Street -->
      <div>
        <label class="block text-sm font-medium mb-1">Rue</label>
        <input
          type="text"
          [(ngModel)]="editStreet"
          name="editStreet"
          class="w-full border rounded px-2 py-1 text-textLight"
        />
      </div>

      <!-- Postal Code -->
      <div>
        <label class="block text-sm font-medium mb-1">Code postal</label>
        <input
          type="text"
          [(ngModel)]="editPostalCode"
          name="editPostalCode"
          class="w-full border rounded px-2 py-1 text-textLight"
        />
        <div
          *ngIf="postalCodeErrorUserUpdate"
          class="text-dangerTail text-xs mt-1"
        >
          {{ postalCodeErrorUserUpdate }}
        </div>
      </div>

      <!-- City -->
      <div>
        <label class="block text-sm font-medium mb-1">Ville</label>
        <input
          type="text"
          [(ngModel)]="editCity"
          name="editCity"
          class="w-full border rounded px-2 py-1 text-textLight"
        />
      </div>

      <!-- Actions -->
      <div class="flex justify-end gap-2 mt-4">
        <button
          type="button"
          class="px-3 py-1 bg-dangerTail hover:bg-dangerTail/80 text-white rounded"
          (click)="closeEditUserModal()"
        >
          Annuler
        </button>
        <button
          type="submit"
          class="px-3 py-1 bg-accentTail dark:bg-accentDarkTail hover:bg-secondaryTail dark:hover:bg-secondaryDarkTail text-white rounded"
        >
          Sauvegarder
        </button>
      </div>
    </form>
  </div>
</div>
